name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          # Alpine - musl libc (no sanitizer support for gcc on musl)
          - distro: alpine
            image: alpine:3.22
            compiler: gcc
            build_type: Debug
            pkg_install: apk add --no-cache build-base cmake bash

          - distro: alpine
            image: alpine:3.22
            compiler: clang
            build_type: Sanitize
            pkg_install: apk add --no-cache build-base cmake bash clang compiler-rt

          # Debian - glibc
          - distro: debian
            image: debian:bookworm
            compiler: gcc
            build_type: Sanitize
            pkg_install: apt-get update && apt-get install -y --no-install-recommends build-essential cmake procps

          - distro: debian
            image: debian:bookworm
            compiler: clang
            build_type: Sanitize
            pkg_install: apt-get update && apt-get install -y --no-install-recommends build-essential cmake clang libclang-rt-dev procps

          # Ubuntu - glibc
          - distro: ubuntu
            image: ubuntu:24.04
            compiler: gcc
            build_type: Sanitize
            pkg_install: apt-get update && apt-get install -y --no-install-recommends build-essential cmake procps

          - distro: ubuntu
            image: ubuntu:24.04
            compiler: clang
            build_type: Sanitize
            pkg_install: apt-get update && apt-get install -y --no-install-recommends build-essential cmake clang libclang-rt-dev procps

          # Fedora - glibc (latest compiler versions)
          - distro: fedora
            image: fedora:41
            compiler: gcc
            build_type: Sanitize
            pkg_install: dnf install -y gcc gcc-c++ cmake make libasan libubsan procps-ng

          - distro: fedora
            image: fedora:41
            compiler: clang
            build_type: Sanitize
            pkg_install: dnf install -y gcc gcc-c++ cmake make clang compiler-rt procps-ng

          # Rocky Linux - RHEL compatible
          - distro: rocky
            image: rockylinux:9
            compiler: gcc
            build_type: Sanitize
            pkg_install: dnf install -y gcc gcc-c++ cmake make libasan libubsan procps-ng

          - distro: rocky
            image: rockylinux:9
            compiler: clang
            build_type: Sanitize
            pkg_install: dnf install -y gcc gcc-c++ cmake make clang procps-ng

          # Amazon Linux 2023 - AWS
          - distro: amazonlinux
            image: amazonlinux:2023
            compiler: gcc
            build_type: Sanitize
            pkg_install: dnf install -y gcc gcc-c++ cmake make libasan libubsan procps-ng

          # Arch Linux - rolling release, latest compilers
          - distro: arch
            image: archlinux:base
            compiler: gcc
            build_type: Sanitize
            pkg_install: pacman -Syu --noconfirm base-devel cmake procps-ng

          - distro: arch
            image: archlinux:base
            compiler: clang
            build_type: Sanitize
            pkg_install: pacman -Syu --noconfirm base-devel cmake clang procps-ng

          # Gentoo - source-based (binary packages need GPG setup)
          - distro: gentoo
            image: gentoo/stage3
            compiler: gcc
            build_type: Debug
            pkg_install: emerge-webrsync && emerge -q dev-build/cmake sys-process/procps

    container:
      image: ${{ matrix.image }}

    name: ${{ matrix.distro }} / ${{ matrix.compiler }}

    env:
      CC: ${{ matrix.compiler == 'clang' && 'clang' || 'gcc' }}
      CXX: ${{ matrix.compiler == 'clang' && 'clang++' || 'g++' }}

    steps:
    - name: Install tar (Amazon Linux)
      if: matrix.distro == 'amazonlinux'
      run: dnf install -y tar gzip

    - uses: actions/checkout@v5

    - name: Install dependencies
      run: ${{ matrix.pkg_install }}

    - name: Build and test
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        cmake --build build --parallel
        ctest --test-dir build --output-on-failure

  test-arm64:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: arm64 / gcc (QEMU)

    steps:
    - uses: actions/checkout@v5

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Build and test on ARM64
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/src:ro \
          -w /build \
          arm64v8/alpine:3.22 sh -c "
            apk add --no-cache build-base cmake bash &&
            cmake /src -DCMAKE_BUILD_TYPE=Debug &&
            cmake --build . --parallel &&
            ctest --output-on-failure
          "

  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v5

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y cmake lcov

    - name: Build with coverage
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Coverage
        cmake --build build --parallel

    - name: Run tests and generate coverage
      run: |
        ctest --test-dir build --output-on-failure
        make -C build coverage
